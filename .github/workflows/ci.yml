name: ULTRATHINK Chaos CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  chaos-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache cargo
      uses: swatinem/rust-cache@v2
      
    - name: Build
      run: cargo build --release
      
    - name: GPU Chaos Test
      uses: nvidia/cuda-action@v1
      with:
        image: ${{ github.repository }}:${{ github.sha }}
        args: >
          --chaos --load 1000rps --duration 300s
      
    - name: Hot-reload Test
      run: cargo test -- --test-threads=1
      
    - name: MCP Integration
      run: cargo run --release -- --mcp-test

  self-improvement:
    runs-on: ubuntu-latest
    needs: chaos-test
    steps:
    - uses: actions/checkout@v4
    
    - name: ε₁ Self-RE Pipeline
      run: |
        cargo run --release -- --self-re \n        && gh pr create --title "Auto-opt: $(date)" --body "ε₁ improvement cycle"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-k8s:
    runs-on: ubuntu-latest
    needs: self-improvement
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to K8s
      uses: deliverybot/helm@v1
      with:
        release: ultrathink
        namespace: production
        chart: ./k8s
        valueFiles: values-prod.yaml
        kubeconfig: ${{ secrets.KUBECONFIG }}
